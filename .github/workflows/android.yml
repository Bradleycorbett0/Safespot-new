name: Build APK

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # ----------------------------
    # 1) CHECKOUT REPO
    # ----------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    # ----------------------------
    # 2) INSTALL SYSTEM DEPENDENCIES
    # Ubuntu 24 removed libncurses5 -> use ncurses6 + tinfo6
    # ----------------------------
    - name: Install System Dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip openjdk-17-jdk python3 python3-pip libncurses6 libtinfo6
        pip install --upgrade pip

    # ----------------------------
    # 3) INSTALL BUILDOZER + CYTHON
    # ----------------------------
    - name: Install Buildozer
      run: |
        pip install cython==0.29.36 buildozer==1.5.0

    # ----------------------------
    # 4) INSTALL ANDROID SDK + NDK
    # ----------------------------
    - name: Install Android SDK components
      run: |
        sudo apt install -y wget
        mkdir -p $HOME/android/sdk
        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdtools.zip
        unzip cmdtools.zip -d $HOME/android/sdk/
        mv $HOME/android/sdk/cmdline-tools $HOME/android/sdk/latest
        yes | $HOME/android/sdk/latest/bin/sdkmanager --sdk_root=$HOME/android/sdk \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;25.2.9519653"

        echo "ANDROIDSDK=$HOME/android/sdk" >> $GITHUB_ENV
        echo "ANDROIDNDK=$HOME/android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "$HOME/android/sdk/platform-tools" >> $GITHUB_PATH

    # ----------------------------
    # 5) BUILD APK WITH BUILDOZER
    # ----------------------------
    - name: Build APK with Buildozer
      run: |
        buildozer android debug

    # ----------------------------
    # 6) UPLOAD APK ARTIFACT
    # ----------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SafeSpot-APK
        path: bin/*.apk
