name: Build Android APK (Buildozer)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk
      ANDROID_API: 33
      ANDROID_MIN_API: 21
      ANDROID_NDK_VERSION: 25.1.8937393
      BUILDOZER_ANDROID_ACCEPT_LICENSE: "True"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          zip unzip curl git \
          build-essential \
          openjdk-17-jdk \
          libffi-dev libssl-dev \
          liblzma-dev zlib1g-dev \
          libsqlite3-dev \
          libncurses-dev \
          libreadline-dev \
          libgdbm-dev \
          libnss3-dev \
          libasound2-dev \
          libpulse-dev \
          libx11-dev libxrandr-dev \
          libxinerama-dev libxcursor-dev \
          libxi-dev

    - name: Install Python tools
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython virtualenv

    # -------------------------------
    # ANDROID SDK (FIXED STRUCTURE)
    # -------------------------------
    - name: Install Android SDK
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        cd $ANDROID_SDK_ROOT/cmdline-tools

        curl -L -o tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q tools.zip

        mkdir -p latest
        mv cmdline-tools/* latest/
        rm -rf cmdline-tools tools.zip

        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

    - name: Install Android SDK packages
      run: |
        sdkmanager --version
        yes | sdkmanager --licenses

        sdkmanager \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;25.1.8937393"

    # -------------------------------
    # BUILDOZER BUILD
    # -------------------------------
    - name: Build APK with Buildozer
      run: |
        buildozer android debug

    # -------------------------------
    # UPLOAD APK (v4 FIX)
    # -------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: SafeSpot-APK
        path: bin/*.apk
