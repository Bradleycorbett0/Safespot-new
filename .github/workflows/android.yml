name: Build Android APK (Buildozer)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    # CRITICAL: pin env at job level so it applies to every step
    env:
      ANDROID_API: "33"
      ANDROID_MIN_API: "21"

      # Force Buildozer to accept licenses non-interactively
      BUILDOZER_ANDROID_ACCEPT_LICENSE: "True"
      ACCEPT_EULA: "Y"

      # IMPORTANT: point Android SDK root to Buildozer's SDK (not GitHub's)
      ANDROIDSDK: /home/runner/.buildozer/android/platform/android-sdk
      ANDROID_SDK_ROOT: /home/runner/.buildozer/android/platform/android-sdk
      ANDROID_HOME: /home/runner/.buildozer/android/platform/android-sdk

      # IMPORTANT: point NDK to Buildozer's NDK r25b (not GitHub's preinstalled)
      ANDROIDNDK: /home/runner/.buildozer/android/platform/android-ndk-r25b
      ANDROID_NDK: /home/runner/.buildozer/android/platform/android-ndk-r25b
      ANDROID_NDK_HOME: /home/runner/.buildozer/android/platform/android-ndk-r25b
      ANDROID_NDK_ROOT: /home/runner/.buildozer/android/platform/android-ndk-r25b

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            zip unzip curl git \
            openjdk-17-jdk \
            build-essential \
            libffi-dev libssl-dev \
            zlib1g-dev \
            libncurses5 \
            libstdc++6 \
            liblzma-dev \
            pkg-config \
            cmake \
            autoconf automake libtool

      - name: Install Buildozer + Cython
        run: |
          python -m pip install --upgrade pip
          python -m pip install "buildozer>=1.5.0" cython virtualenv

      # IMPORTANT: ensure GitHub's injected NDK vars do not override ours inside the runner context
      - name: Hard reset Android variables (override GitHub defaults)
        run: |
          echo "Before override:"
          env | grep -E '^ANDROID_(NDK|SDK|HOME|S).*' || true

          # Remove GitHub hosted NDK pointers if present
          unset ANDROID_NDK_LATEST_HOME || true

          # Re-export what we want (job env already sets them, this reinforces it)
          export ANDROIDSDK="/home/runner/.buildozer/android/platform/android-sdk"
          export ANDROID_SDK_ROOT="$ANDROIDSDK"
          export ANDROID_HOME="$ANDROIDSDK"

          export ANDROIDNDK="/home/runner/.buildozer/android/platform/android-ndk-r25b"
          export ANDROID_NDK="$ANDROIDNDK"
          export ANDROID_NDK_HOME="$ANDROIDNDK"
          export ANDROID_NDK_ROOT="$ANDROIDNDK"

          # Persist for subsequent steps explicitly
          echo "ANDROIDSDK=$ANDROIDSDK" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV

          echo "ANDROIDNDK=$ANDROIDNDK" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_NDK" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV

          echo "After override:"
          env | grep -E '^ANDROID_(NDK|SDK|HOME|S).*' || true

      - name: Build APK (debug)
        run: |
          # sanity check in the same step that runs buildozer
          echo "NDK used for build should be r25b:"
          echo "ANDROID_NDK=$ANDROID_NDK"
          ls -la "$ANDROID_NDK" || true

          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: safespot-apk
          path: bin/*.apk
